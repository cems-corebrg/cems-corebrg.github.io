<!DOCTYPE html>
<html>
	<head>
        <meta charset="UTF-8">
        <meta http-equiv="Cache-Control" content="no-cache">
		<title>Dialog @ Line</title>
		
		<style>
@import "/css/style.css";
@import "/css/fa.css";
@import "/css/dialog.css";

h3 {
	margin: unset;
    padding: 1em;
    background-color: #dddddd;
}

section {
    position: relative;
    overflow: hidden;
}

.dialog {
	width: 380px;
	padding: 20px;
	background-color: #fff;
}

#create {
    font: 1em "Font Awesome 5 Free", "맑은 고딕";
    width: 100%;
    padding: 4em;
    box-sizing: border-box;
    text-align: center;
}

.link {
    border: 1px solid #aaa;
}

.button {
    font-family: "Font Awesome 5 Free", "맑은 고딕";
    display: inline-block;
    cursor: pointer;
}

.button.remove {
    color: #dc3545;
}

.button.apply {
    color: #28a745;
}

.button:hover {
    transform: translateY(-2px);
}

.button:active {
    transform: none;
}

.container {
    position: relative;
}

.loading.mask {
    position: absolute;
}

tbody:first-of-type {
    background-color: #e0e0e0;
}

tbody:first-of-type th {
    padding: 0.5em;
}

.close {
    position: absolute; inset: 1em 1em auto auto;
    font: 20px "Font Awesome 5 Free";
    border-radius: 50%;
    display: inline-flex; width: 32px; height: 32px;
    align-items: center;
    justify-content: center;
    color: #000000;
    cursor: pointer;
}

.close:hover {
    transform: scale(1.2);
}

body:not(.initialized) form,
body.initialized #create,
dialog:not([data-id]) [type=reset] {
	display: none;
}

		</style>
		
        <script src="/js/snmp.js"></script>
        <script>

function onCreatePath (e) {
    document.body.classList.add("loading");

    $.request.query ({
        command: "add",
        target: "path",
        path: {
            nodeFrom: $.idFrom,
            nodeTo: $.idTo
        }
    })
    .then(data => {
        return $.request.query({
            command: "get",
            target: "link",
            link: {
                path: data.id
            }
        });
    }).then(data => {
        if (data) {
            let link;

            for (const id in data) {
                link = data[id];

                // DB에서 index를 long 형으로 다룬다. (Why?)
                if ("indexFrom" in link) {
                    link.indexFromName = $.nodeFrom.get(String(link.indexFrom))?.get("name") ?? undefined;
                }

                if ("indexTo" in link) {
                    link.indexToName = $.nodeTo.get(String(link.indexTo))?.get("name") ?? undefined;
                }
            }

            if (link) {
                return $.request.query({
                    command: "set",
                    target: "link",
                    link: link
                });
            }
        }
    }).then(data => {
        top.reloadOpener();

        window.location.reload();
    }).catch(showMessage);
}

function onSubmit (e) {
    e.preventDefault();

    const path = {
            id: $.id,
            type: "",
            color: "",
            size: 0
        };

    $.options.forEach(name => {
        if ($.form.elements["use_"+ name].checked && $.form.elements[name].value) {
            path[name] = $.form.elements[name].value;
        }
    });
    
    $.request.execute({
        command: "set",
        target: "path",
        path: path
    }, function () {
        switch(this.status) {
        case 200:
            top.closeDialog(true);

            break;
        default:
            throw showMessage(this);
        }
    });
}

function onReset (e) {
    e.preventDefault();

    if (!(confirm(CONFIRM_REMOVE(CONST_PATH["kr"])["kr"]))) {
        return;
    }

    document.body.classList.add("loading");
    
    $.request.execute({
        command: "remove",
        target: "path",
        path: {
            id: $.id
        }
    }, function () {
        switch(this.status) {
        case 200:
            top.closeDialog(true);

            break;
        default:
            throw showMessage(this);
        }
    });
}

function showMessage(xhr) {
    if (xhr instanceof XMLHttpRequest) {
        switch (xhr.status) {
        case 401:
            alert(NOTICE_SESS_EXPIRE["kr"]);

            break;
        default:
            alert(ERROR_RES_CODE(xhr.status)["kr"]);
        }

        try {
            console.log(JSON.parse(xhr.responseText).error);
        } catch (e) {}
    } else if (xhr instanceof Error) {
        console.error(xhr);
    } else {
        console.trace();
    }
}
        </script>
	</head>
	
	<body class="loading">
	
		<main>
            <h2>
                <span  id="close" title="대화창 닫기">&#xf00d;</span>
                경로
            </h2>
            <section>
                <button id="create">&#xf067; 생성</button>
                <form>
                    <table>
                        <colgroup>
                            <col width="100">
                            <col>
                            <col>
                            <col width="50%">
                        </colgroup>
                        <tbody>
                            <tr>
                                <th colspan="3" id="node_from"></th>
                                <th id="node_to"></th>
                                
                            </tr>
                            <tr>
                                <td colspan="3">
                                    <select id="index_from" disabled></select>
                                </td>
                                <td>
                                    <select id="index_to" disabled></select>
                                </td>
                            </tr>
                        </tbody>
                        <tbody>
                            <tr>
                                <th>선 종류</th>
                                <td><input type="checkbox" name="use_type"></td>
                                <td colspan="2">
                                    <select name="type" required disabled>
                                        <option value="clock">꺽은선(시계방향)</option>
                                        <option value="counter">꺽은선(반시계방향)</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <th>선 색상</th>
                                <td><input type="checkbox" name="use_color"></td>
                                <td colspan="2"><input type="color" name="color" placeholder="기본" required disabled></td>
                            </tr>
                            <tr>
                                <th>선 두께</th>
                                <td><input type="checkbox" name="use_size"></td>
                                <td colspan="2"><input type="number" name="size" placeholder="기본" required disabled></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <footer class="root">
                        <button type="reset">&#xf1f8; Remove</button>
                        <button type="submit">&#xf00c; Apply</button>
                    </footer>
                </form>
                <div class="loading mask"></div>
            </section>
        </main>
        
        <script src="/js/request.js"></script>
        <script src="/js/constants.js"></script>
        <script src="/js/snmp.js"></script>
        <script src="/js/dialog.js"></script>
		<script>

const
    search = new URLSearchParams(window.location.search),
    $ = {
        request: new Request(),
        form: document.querySelector("form"),
        customInputMap: {},
        idFrom: Number(search.get("from")) || undefined,
        idTo: Number(search.get("to")) || undefined,
        options: ["type", "color", "size"]
    };

document.getElementById("create").onclick = onCreatePath;

$.options.forEach(name => {
    $.form.elements["use_"+ name].onclick = e => {
        const element = $.form.elements[name];

        if (e.currentTarget.checked) {
            element.disabled = false;
            element.focus();
        }
        else {
            element.value = "";
            element.disabled = true;
        }
    };
});

function parseResource (resource) {
    const indexData = new Map();

    ["astatus", "ostatus", "interface"].forEach(template => {
        if (template in resource) {
            const templateData = resource[template];
            let oidData;

            for (const oid in templateData) {
                oidData = templateData[oid];

                for (const index in oidData) {
                    if (indexData.has(index)) {
                        item = indexData.get(index);
                    } else {
                        indexData.set(index, item = new Map());
                    }

                    item.set(template, oidData[index].value);

                    if (template === "interface") {
                        item.set("name", oidData[index].name);
                    }
                }
            }
        }
    });

    return indexData;
}

function initResource(indexData, select) {
    const
        df = document.createDocumentFragment(),
        typeToOptgroup = new Map();
    let item, type, optgroup, option;

    for (const [index, item] of indexData) {
        type = item.get("interface"); // String

        if (item.has("name")) {
            optgroup = typeToOptgroup.get(type);

            if (!optgroup) {
                optgroup = document.createElement("optgroup");
                optgroup.label = ITAhM.snmp.ifType[type];

                typeToOptgroup.set(type, optgroup);
            }
            
            option = document.createElement("option");
                
            option.value = index;
            option.text = item.get("name");
            
            if (Number(item.get("astatus")) !== 1) {
                option.disabled = true;
            }

            optgroup.appendChild(option);
        }
    }

    for (const [type, optgroup] of typeToOptgroup) {
        df.appendChild(optgroup);
    }
    
    select.appendChild(df);

    select.selectedIndex = -1;

    select.disabled = false;
}

        </script>
        <script type="module">
import Channel from "../js/module/channel.js";

Channel.request("account", account => {
    if (account.level === 0) {
        $.form.onsubmit = onSubmit;
        $.form.onreset = onReset;

        document.body.classList.add("root");
    }

    $.request.query({
        command: "get",
        target: "path",
        path: {
            nodeFrom: $.idFrom,
            nodeTo: $.idTo
        }
    }).then(data => {
        if (data) {
            return $.request.query({
                command: "get",
                target: "config",
                config: {
                    key: "CUSTOMLINE"
                }
            });
        }
    }).then(configData => {
        if (configData) {
            const df = document.createDocumentFragment();
            
            configData["CUSTOMLINE"].split(',').forEach((custom, i) => {
                const
                    tr = df.appendChild(document.createElement("tr")),
                    input = document.createElement("input");

                tr.appendChild(document.createElement("th")).textContent = custom;
                tr.appendChild(document.createElement("td")).appendChild(input);

                input.type = "text";

                $.customInputMap[custom] = input;
            });
            
            document.body.querySelector("dialog tbody").appendChild(df);
        }

        return $.request.query({
            command: "get",
            target: "node",
            node: {
                id: $.idFrom,
                resource: true
            }
        });
    })
    .then(data => {
        document.getElementById("node_from").textContent = data.name || data.ip || "노드.1";

        if (data.resource) {
            $.nodeFrom = parseResource(data.resource);

            initResource($.nodeFrom, document.getElementById("index_from"));
        }

        return $.request.query({
            command: "get",
            target: "node",
            node: {
                id: $.idTo,
                resource: true
            }
        });
    })
    .then(data => {
        document.getElementById("node_to").textContent = data.name || data.ip || "노드.2";

        if (data.resource) {
            $.nodeTo = parseResource(data.resource);

            initResource($.nodeTo, document.getElementById("index_to"));
        }

        return $.request.query({
            command: "get",
            target: "path",
            path: {
                nodeFrom: $.idFrom,
                nodeTo: $.idTo
            }
        });
    })
    .then(data => {
        if (data) {
            const path = data;
            
            $.id = path.id;

            $.options.forEach(name => {
                if (path[name]) {
                    $.form.elements[name].value = path[name];
                    $.form.elements[name].disabled = false;
                    $.form.elements["use_"+ name].checked = true;
                }
            });
            
            document.body.classList.add("initialized", "edit");

            return $.request.query({
                command: "get",
                target: "link",
                link: {
                    path: $.id
                }
            });
        }
    })
    .then(data => {
        if (data) {
            let link;

            for (let id in data) {
                link = data[id];
                
                document.getElementById("index_from").value = link.indexFrom;
                document.getElementById("index_to").value = link.indexTo;
            }
        }
        
        document.body.classList.remove("loading");
    })
    .catch(showMessage);
});
		</script>
	
	</body>
	
</html>