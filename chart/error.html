<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="Cache-Control" content="No-Cache">
		
		<title>ITAhM</title>
		
		<style>
		
@import "/css/style.css";
@import "/css/fa.css";

body {
	position: fixed; top: 0; right: 0; bottom: 0; left: 0;
	margin: 0; padding: 0;
	display: flex; flex-direction: column;
	color: #ffffff;
}

header {
    flex: none;
    position: relative;
}

.switch {
    line-height: 2em;
    padding-left: 2em;
    padding-right: 2em;
    border-radius: 1.5em;
    border: 1px solid #ffffff;
}

.switch__toggle {
    vertical-align: sub;
}

main {
    flex: 1;
    display: flex; flex-direction: column;
}

.chart {
    flex: 1;
}

iframe {
    width: 100%; height: 100%;
    margin: 0; padding: 0;
    border: none;
}

h2 {
	text-align: center;
    margin: 0;
    padding: 0.5em;
    background-color: #777;
    text-shadow: 0 2px 3px #000;
}

body:not(.root) form {
    display: none;
}
        </style>
        
		<script>
/**
 * public
 */
 function getFile() {
    document.getElementById("chart_in").contentWindow.getFile();
    document.getElementById("chart_out").contentWindow.getFile();
}

function realtime(realtime) {
    document.getElementById("chart_in").contentWindow.realtime(realtime);
    document.getElementById("chart_out").contentWindow.realtime(realtime);
}

function detail() {
    document.getElementById("chart_in").contentWindow.detail();
    document.getElementById("chart_out").contentWindow.detail();
}

function draw (from, to) {
    document.getElementById("chart_in").contentWindow.draw(from, to);
    document.getElementById("chart_out").contentWindow.draw(from, to);
}

function preview (resourceData) {
    parent.preview(resourceData);
}

function onCheckMonitor (e) {
    const checked = this.checked;

    if (!confirm(`Confirm.\n\n${checked? "인터페이스의 상태를 모니터 하겠습니까?": "인터페이스의 모니터를 해제 하겠습니까?"}`)) {
        return this.checked = !checked;
    }

    $.request.query({
        command: checked? "set": "remove",
        target: "match",
        match: {
            id: $.id,
            oid: ITAhM.snmp.oid.ifOperStatus,
            index: $.index,
            value: "1"
        }
    }).then(match => {
    }).catch(showMessage);
}

function showMessage(xhr) {
    if (xhr instanceof XMLHttpRequest) {
        switch (xhr.status) {
        case 401:
            alert(NOTICE_SESS_EXPIRE["kr"]);

            break;
        default:
            alert(ERROR_RES_CODE(xhr.status)["kr"]);
        }

        try {
            console.log(JSON.parse(xhr.responseText).error);
        } catch (e) {}
    } else if (xhr instanceof Error) {
        console.error(xhr);
    } else {
        console.trace(xhr);
    }
}
		</script>
	</head>
	
	<body class="loading">
        <header>
			<h2>Interface error: <i>"</i> <span id="if_name"></span> <i>"</i></h2>
            <label class="switch">
                인터페이스 상태 감시
                <input type="checkbox">
                <span class="switch__toggle"></span>
            </label>
        </header>
        <main>
            <div class="chart">
                <iframe id="chart_in"></iframe>
            </div>
            <div class="chart">
                <iframe id="chart_out"></iframe>
            </div>
        </main>
        <div class="loading mask"></div>

        <script src="/js/ITAhM.js"></script>
        <script src="/js/snmp.js"></script>
        <script src="/js/constants.js"></script>
        <script src="/js/request.js"></script>
		<script>

const
    INTERVAL = 5000,
    search = new URLSearchParams(window.location.search),
    $ = {
        request: new Request(),
        id: Number(search.get("id")),
        index: search.get("index"),
        input: JSON.parse(decodeURIComponent(search.get("input"))),
        output: JSON.parse(decodeURIComponent(search.get("output"))),
    };

document.getElementById("if_name").textContent =  search.get("title") || "";

search.set("oid", $.input.oid);
search.set("index", $.input.index);
document.getElementById("chart_in").src=`/chart/errorIn.html?${search.toString()}`;

search.set("oid", $.output.oid);
search.set("index", $.output.index);
document.getElementById("chart_out").src=`/chart/errorOut.html?${search.toString()}`;

        </script>
        <script type="module">
import Channel from "../../js/module/channel.js";

Channel.request("account", account => {
    if (account.level === 0) {
        document.body.querySelector(".switch").onclick = onCheckMonitor;

        document.body.classList.add("root");
    }
    $.request.query({
        command: "get",
        target: "match",
        match: {
            id: $.id,
            oid: ITAhM.snmp.oid.ifOperStatus,
            index: $.index
        }
    }).then(match => {
        document.body.querySelector(".switch [type=checkbox]").checked = "value" in match;

        document.body.classList.remove("loading");
    }).catch(showMessage);
});
		</script>
	
	</body>
	
</html>